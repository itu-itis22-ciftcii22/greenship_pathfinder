<?xml version="1.0"?>
<launch>
    <!-- ========================================== -->
    <!-- AUTONOMOUS SHIP NAVIGATION LAUNCH         -->
    <!-- ========================================== -->
    
    <!-- Parameters -->
    <arg name="navigation_mode" default="collision_avoidance" doc="collision_avoidance or maneuvering" />
    <arg name="fcu_url" default="/dev/ttyACM0:57600" />
    <arg name="gcs_url" default="" />
    <arg name="tgt_system" default="1" />
    <arg name="tgt_component" default="1" />
    <arg name="log_level" default="INFO" />
    <arg name="mission_radius" default="2.0" />
    <arg name="timeout_per_waypoint" default="120" />
    
    <!-- Set ROS Log Level -->
    <env name="ROSCONSOLE_CONFIG_FILE" value="$(find autonomous_ship)/config/rosconsole.conf"/>
    
    <!-- ========================================== -->
    <!-- MAVROS (Vehicle Communication) -->
    <!-- ========================================== -->
    <include file="$(find mavros)/launch/px4.launch">
        <arg name="fcu_url" value="$(arg fcu_url)" />
        <arg name="gcs_url" value="$(arg gcs_url)" />
        <arg name="tgt_system" value="$(arg tgt_system)" />
        <arg name="tgt_component" value="$(arg tgt_component)" />
        <arg name="log_output" value="screen" />
    </include>
    
    <!-- ========================================== -->
    <!-- Navigation Controller Selection -->
    <!-- ========================================== -->
    
    <!-- Collision Avoidance Mode -->
    <group if="$(eval navigation_mode == 'collision_avoidance')">
        <node name="collision_avoidance_controller" pkg="autonomous_ship" type="collision_avoidance.py" 
              output="screen" required="true">
            <param name="log_level" value="$(arg log_level)" />
            <param name="mission_radius" value="$(arg mission_radius)" />
            <param name="timeout_per_waypoint" value="$(arg timeout_per_waypoint)" />
            <remap from="/fusion_output" to="/fusion_output" />
            <remap from="/mavros/state" to="/mavros/state" />
            <remap from="/mavros/home_position/home" to="/mavros/home_position/home" />
            <remap from="/mavros/global_position/global" to="/mavros/global_position/global" />
            <remap from="/mavros/mission/waypoints" to="/mavros/mission/waypoints" />
        </node>
    </group>
    
    <!-- Maneuvering Mode -->
    <group if="$(eval navigation_mode == 'maneuvering')">
        <node name="maneuvering_controller" pkg="autonomous_ship" type="maneuvering.py" 
              output="screen" required="true">
            <param name="log_level" value="$(arg log_level)" />
            <param name="mission_radius" value="$(arg mission_radius)" />
            <param name="timeout_per_waypoint" value="$(arg timeout_per_waypoint)" />
            <remap from="/fusion_output" to="/fusion_output" />
            <remap from="/mavros/state" to="/mavros/state" />
            <remap from="/mavros/home_position/home" to="/mavros/home_position/home" />
            <remap from="/mavros/global_position/global" to="/mavros/global_position/global" />
            <remap from="/mavros/mission/waypoints" to="/mavros/mission/waypoints" />
        </node>
    </group>
    
    <!-- Basic Core Mode (Fallback) -->
    <group if="$(eval navigation_mode == 'basic')">
        <node name="basic_controller" pkg="autonomous_ship" type="autopath_core_starter.py" 
              output="screen" required="true">
            <param name="log_level" value="$(arg log_level)" />
            <remap from="/fusion_output" to="/fusion_output" />
        </node>
    </group>
    
    <!-- ========================================== -->
    <!-- Safety Monitor -->
    <!-- ========================================== -->
    <node name="safety_monitor" pkg="autonomous_ship" type="safety_monitor.py" 
          output="screen" required="false">
        <param name="emergency_stop_distance" value="2.0" />
        <param name="max_distance_from_home" value="1000.0" />
        <remap from="/navigation_obstacles" to="/navigation_obstacles" />
        <remap from="/mavros/state" to="/mavros/state" />
    </node>
    
    <!-- ========================================== -->
    <!-- Mission Status Publisher -->
    <!-- ========================================== -->
    <node name="mission_status" pkg="autonomous_ship" type="mission_status.py" 
          output="screen" required="false">
        <remap from="/mavros/mission/waypoints" to="/mavros/mission/waypoints" />
        <remap from="/mavros/global_position/global" to="/mavros/global_position/global" />
    </node>
    
</launch>